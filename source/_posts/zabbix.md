---
title: zabbixç›‘æ§æ–¹æ¡ˆ
date: 2020-05-29 21:14:51
tags:
  - zabbix
  - ç›‘æ§å‘Šè­¦
---

### æ¦‚å†µ

zabbixæ˜¯ä¸€ä¸ªè€ç‰Œçš„å¼€æºåˆ†å¸ƒå¼ç›‘æ§æ–¹æ¡ˆï¼Œå®ƒæ˜¯ç”±Alexei Vladishevåœ¨2000å¹´å·¦å³åˆ›å»ºï¼ˆPS: é‚£æ—¶æˆ‘åˆšå¥½å‡åˆä¸­ ğŸ˜€ï¼‰ï¼Œæœ€æ—©ä¸»è¦ç”¨æ¥ç›‘æ§ç½‘ç»œå’ŒæœåŠ¡å™¨çš„å¥åº·åº¦å’Œå®Œæ•´æ€§ã€‚

å¦‚æœæŒ‰ç…§ä¸­å›½çš„æ³•å¾‹ï¼Œåˆ°ç°åœ¨çš„2020å¹´ï¼Œzabbixå·²ç»æˆå¹´ã€‚

ç»è¿‡è¿‘20å¹´çš„å‘å±•ï¼Œzabbixå·²ç”±æœ€åˆçš„ç½‘ç»œå’ŒæœåŠ¡å™¨ç›‘æ§æ‰©å±•åˆ°åº”ç”¨ç›‘æ§å’Œwebç›‘æ§ç­‰æ›´ä¸°å¯Œçš„ç›‘æ§ç›®æ ‡ï¼Œæ•°æ®åº“æ”¯æŒå·²ä»mysqlè¦†ç›–åˆ°äº†elasticsearchã€oracleç­‰æ›´å¤šçš„ç¬¬ä¸‰æ–¹æ•°æ®åº“ï¼Œå‘Šè­¦å‡½æ•°ä¹Ÿä»æœ€åˆçš„6ä¸ªå¢åŠ åˆ°äº†5.0ç‰ˆæœ¬çš„29ä¸ªã€‚

### æ¶æ„

zabbixçš„æ¶æ„æ¯”è¾ƒå…¸å‹ï¼Œåˆ†ä¸ºé‡‡é›†ç«¯ã€å±•ç¤ºç«¯ã€å‘Šè­¦ç«¯ã€‚é‡‡é›†ç«¯ä¸»è¦é€šè¿‡agenté‡‡é›†ä¿¡æ¯ï¼Œå¹¶ä¸ŠæŠ¥åˆ°serverï¼Œæ•°æ®å­˜å‚¨åœ¨mysqlç­‰æ•°æ®åº“ä¸­ã€‚

ä¸‹é¢æ˜¯zabbixæ•°æ®é‡‡é›†ç«¯æ¥å…¥zabbixçš„æ¶æ„å›¾ï¼š

![zabbix-proxy](/images/zabbix-proxy.png)

ä¸ºäº†æ€§èƒ½çš„è€ƒè™‘ï¼Œzabbixæœ‰ç±»ä¼¼elkç­‰æ¶æ„çš„å…¸å‹ç‰¹ç‚¹ï¼Œagentå’Œserveré—´æ”¯æŒåŠ å…¥ä¸€ä¸ªproxyæ¥å‡è¡¡è´Ÿè½½ã€‚

2019å¹´çš„4.4ç‰ˆæœ¬ä¸­ï¼Œå®˜æ–¹å¼€å§‹æä¾›åŸºäºgolangçš„agent2ä½œä¸ºä¸ŠæŠ¥ç«¯ï¼Œæ€§èƒ½å’Œç»´æŠ¤æ€§ä¸Šä¹Ÿä¼šå¥½å¾ˆå¤šã€‚æœªæ¥æœ‰æœ›å–ä»£cç‰ˆæœ¬çš„agentã€‚

### agent2æºç è§£è¯»

è¿™é‡Œä»¥5.2.0alpha1ä¸ºå‡†ï¼Œæ¥åˆ†æä¸€ä¸‹agent2çš„æ ¸å¿ƒå®ç°ã€‚ä»£ç å¯¹åº”å“ˆå¸Œ86c3d82ï¼Œagent2å¯¹åº”çš„ä»£ç åœ¨src/goä¸‹ã€‚

zabbixåŒæ—¶æ”¯æŒä¸»åŠ¨ä¸ŠæŠ¥å’Œè¢«åŠ¨è¯·æ±‚ä¸¤ç§ï¼Œä¸»åŠ¨ä¸ŠæŠ¥æ˜¯agentä¸»åŠ¨å‘èµ·çš„ä¸ŠæŠ¥ï¼Œè€Œè¢«åŠ¨è¯·æ±‚æ˜¯ç”±serverç«¯å‘èµ·ã€‚

agent2ä»£ç é‡æ¯”è¾ƒåºå¤§ï¼Œä½†æ˜¯ç›®å½•ç»“æ„å’Œå¤„ç†é€»è¾‘æ¯”è¾ƒæ¸…æ™°ã€‚æ ¸å¿ƒä»£ç ä¸»è¦é›†ä¸­åœ¨internal/agentä¸­ã€‚

ä»agent2çš„æ€»ä½“è®¾è®¡æ¥çœ‹ï¼Œæ•´ä¸ªæ‰§è¡Œé€»è¾‘åˆ†ä¸ºscheduler.Managerã€server.Connectorã€ServerListenerä¸‰ä¸ªä¸»è¦é€»è¾‘ï¼ˆgoroutineå¯åŠ¨ï¼‰ï¼Œä¸»ç¨‹åºå¯¹ä¸‰ä¸ªgoroutineè¿›è¡Œç›‘æ§ã€‚

å…¶ä¸­ï¼ŒSchedulerManagerè´Ÿè´£æ•°æ®é‡‡é›†ã€é…ç½®æ›´æ–°çš„è°ƒåº¦ï¼›ServerConnecterç”¨äºä¸serverçš„è¿æ¥ï¼Œè´Ÿè´£æ›´æ–°ç›‘æ§é¡¹é…ç½®ï¼›ServerListenerä¸»è¦ç›‘æ§serverç«¯å‘èµ·çš„è¢«åŠ¨è¯·æ±‚ã€‚

è¿™é‡Œä»¥ä¸‰ä¸ªå°æ¡ç›®æ¥åˆ†åˆ«è®¨è®ºagent2çš„å®ç°ï¼Œåˆ†åˆ«æ˜¯ç›‘æ§é¡¹åŒæ­¥ã€pluginæœºåˆ¶ä»¥åŠä¸€ä¸ªç®€å•çš„pluginå®ç°ã€‚

#### ç›‘æ§é¡¹åŒæ­¥

serverç«¯å¯åŠ¨æ—¶ä¼šç›‘å¬ä¸€ä¸ªç«¯å£ï¼ˆé»˜è®¤10051ï¼‰ï¼Œagent2ä¼šå®šæœŸä»è¯¥ç«¯å£æ‹‰å–ç›‘æ§é¡¹ï¼Œé»˜è®¤æ¯ä¸¤åˆ†é’Ÿæ‹‰å–ä¸€æ¬¡ã€‚

å‰é¢è¯´è¿‡ï¼Œæ‹‰å–æ˜¯ç”±server.Connectoræ¥åšçš„ï¼Œå®ƒä»serverç«¯è·å–é…ç½®é¡¹åï¼Œåšä¸€äº›ç®€å•å¤„ç†ï¼Œå¹¶å°†å…¶åŒ…è£…ä¸ºupdateRequestï¼Œç„¶åå°†é…ç½®ä½œä¸ºinputè¾“å…¥åˆ°scheduler.Managerä¸­ã€‚

scheduler.Managerçš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š

```go
type Manager struct {
	input       chan interface{}
	plugins     map[string]*pluginAgent
	pluginQueue pluginHeap
	clients     map[uint64]*client
	aliases     *alias.Manager
	// number of active tasks (running in their own goroutines)
	activeTasksNum int
	// number of seconds left on shutdown timer
	shutdownSeconds int
}
```

inputæ˜¯ä¸€ä¸ªè¾“å…¥æºï¼Œä¸Šé¢server.Connectorå³æ˜¯å°†updateRequestå‘é€åˆ°Manager.inputã€‚

Managerä¼šä¸€ç›´ç›‘å¬Manager.inputï¼Œæ£€æµ‹åˆ°*updateRequeståï¼Œä¼šå°†updateRequestsä¸­åŒ…å«çš„é…ç½®æ›´æ–°åˆ°pluginså­—æ®µä¸­ï¼Œåé¢ä¼šæ ¹æ®pluginsåšæ”¶é›†å’Œä¸ŠæŠ¥ã€‚

é¢å¤–è¡¥å……ä¸ªï¼Œinputè¿˜æœ‰ä¸¤ç±»è¾“å…¥ï¼Œ`performer`ã€`*queryRequest`ï¼Œ`performer` å¯¹åº”ç›‘æ§é‡‡é›†äº‹ä»¶ï¼Œè€Œ `*queryRequest` å¯¹åº”è¢«åŠ¨è¯·æ±‚çš„äº‹ä»¶ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶agent2é»˜è®¤æ”¯æŒå¾ˆå¤šç›‘æ§é¡¹ï¼Œä½†æ˜¯å®ƒä»¬ä¸ä¼šä¸»åŠ¨é‡‡é›†ã€‚åªæœ‰serverç«¯é…ç½®äº†ç›‘æ§é¡¹çš„æŒ‡æ ‡æ‰ä¼šè¢«é‡‡é›†ä¸ŠæŠ¥ã€‚

#### pluginæœºåˆ¶

agent2ä¸­ï¼Œpluginæœºåˆ¶ä¸ºpluginé¢„ç•™äº†å¤šç§æ¥å£å¯ä¾›å®ç°ä¸åŒé˜¶æ®µå’ŒåŠŸèƒ½çš„é€»è¾‘ï¼Œå¦‚ä¸‹ï¼š

* Collectorï¼šå®šæœŸæ”¶é›†æŒ‡æ ‡ã€‚ä¸€èˆ¬ä¸Exporterç»“åˆï¼Œä»¥ä¾¿å°†æ”¶é›†çš„æŒ‡æ ‡ä¸ŠæŠ¥ç»™server
* Exporterï¼šä¸ŠæŠ¥æŒ‡æ ‡æ•°æ®åˆ°serverã€‚Exporteræ˜¯è¿™å‡ ä¸ªæ¥å£ä¸­å”¯ä¸€ä¸€ä¸ªå¯ä»¥å¹¶è¡Œå¤„ç†çš„æ¥å£
* Runnerï¼šå¯åœ¨è¯¥æ¥å£å®ç°åˆå§‹åŒ–å’Œæ¸…ç†æ“ä½œ
* Watcherï¼šå¯å®ç°è‡ªå®šä¹‰çš„æŒ‡æ ‡é‡‡é›†è°ƒåº¦æ–¹å¼
* Configuratorï¼šå¤„ç†é…ç½®å†…å®¹ï¼Œå¦‚é…ç½®çš„æœ‰æ•ˆæ€§åˆ¤æ–­

pluginå¯ä»¥é€‰æ‹©å®ç°å…¶ä¸­çš„ä¸€ç»„æˆ–å¤šç»„æ¥å£ï¼Œæ¥æä¾›ä¸åŒåŠŸèƒ½çš„å¤„ç†ã€‚

agent2æä¾›äº†ä¸€ä¸ªæŒ‡æ ‡æ³¨å†Œå‡½æ•°ï¼Œæ¥æ³¨å†ŒpluginåŠå…¶æ”¯æŒçš„æŒ‡æ ‡ï¼Œæ¥å£å®šä¹‰å¦‚ä¸‹ï¼š

```go
func RegisterMetrics(impl Accessor, name string, params ...string)
```

å…¶ä¸­ï¼Œimplå³ä¸ºå®ç°äº†pluginæ¥å£çš„ç»“æ„ä½“ï¼Œä¸‹é¢å°†ä½¿ç”¨ä¸€ä¸ªä¾‹å­æ¥å±•ç¤ºå¦‚ä½•æ³¨å†Œã€‚

scheduler.Manageråœ¨åˆå§‹åŒ–æ—¶ï¼Œä¼šå°†æ”¯æŒçš„pluginsä¿¡æ¯å†™å…¥Manager.pluginsã€‚ä¸Šé¢è¯´çš„é…ç½®é¡¹ä¹Ÿä¼šæ›´æ–°åˆ°è¿™é‡Œã€‚pluginså­—æ®µæ˜¯ä¸€ä¸ªæ ¸å¿ƒå­—æ®µã€‚

### æ’ä»¶ç¤ºä¾‹

è¿™é‡Œç»™å‡ºä¸€ä¸ªåˆ©ç”¨æ’ä»¶æœºåˆ¶å®ç°çš„ç®€å•æ’ä»¶ï¼Œè¯¥æ’ä»¶æä¾›äº†ä¸¤ä¸ªmetricåˆ†åˆ«ç”Ÿæˆä¸€ä¸ªéšæœºæ•´æ•°å’Œä¸€ä¸ªéšæœºæµ®ç‚¹æ•°ã€‚

è¯¥æ’ä»¶åªå®ç°äº†Exporteræ¥å£ï¼Œå¹¶åœ¨init()ä¸­æ³¨å†Œäº†è¯¥æ’ä»¶åŠä¸¤ä¸ªç›‘æ§é¡¹ã€‚

```go
type Plugin struct {
	plugin.Base
}

func (Plugin) Export(key string, params []string, context plugin.ContextProvider) (interface{}, error) {
	switch key {
	case "test.randint":
		return rand.Int(), nil
	case "test.randfloat":
		return rand.Float32(), nil
    default:
        return nil, errors.New(fmt.Sprintf("Unknown metric %s!", key))
	}
	return rand.Int(), nil
}

var impl Plugin

func init() {
	plugin.RegisterMetrics(&impl, "test",
		"test.randint", "Export random int.",
		"test.randfloat", "Export random float.")
}
```

pluginsä¸‹æœ‰plugins_darwin.goã€plugins_linux.goã€plugins_windowsï¼Œé‡Œé¢åˆ†åˆ«é…ç½®äº†ä¸åŒæ“ä½œç³»ç»Ÿä¸‹æ”¯æŒçš„ç›‘æ§é¡¹ï¼ŒæŠŠtestæ’ä»¶è®°å½•è¿›å»å³å¯æ”¯æŒè¯¥ç›‘æ§äº†ã€‚

### zabbixä¼˜ç¼ºç‚¹

ä½œä¸ºä¸€ä¸ªè€ç‰Œç›‘æ§æ–¹æ¡ˆï¼Œzabbixæä¾›çš„é»˜è®¤ç›‘æ§æ¯”è¾ƒå…¨é¢ï¼Œè€Œä¸”æŠ€æœ¯ä¸Šæœ‰ä¸€å®šç§¯ç´¯ï¼Œè¿è¡Œæ¯”è¾ƒç¨³å®šã€‚zabbixçš„éƒ¨ç½²ç›¸å¯¹æ¯”è¾ƒç®€å•ã€‚

zabbixçš„æ•°æ®åº“å¤šä¸ºmysqlç­‰ç»“æ„å‹æ•°æ®åº“æˆ–è€…elasticsearchç­‰æ–‡æ¡£å‹æ•°æ®åº“ï¼Œç¼ºå°‘å¯¹æ—¶åºæ•°æ®åº“çš„æ”¯æŒã€‚

è™½ç„¶å®˜ç½‘ä¹Ÿæœ‰é›†æˆinfluxdbçš„æ–¹æ¡ˆï¼ˆé“¾æ¥è§å‚è€ƒéƒ¨åˆ†ï¼‰ï¼Œä½†éƒ½ä¸æ˜¯å®˜æ–¹é›†æˆï¼Œä¸”éœ€è¦ä¸å…¶å®ƒå¹³å°ç»“åˆä½¿ç”¨ã€‚æœ€å—æ¬¢è¿çš„æ–¹æ¡ˆ3å¹´ä¹Ÿåªæœ‰60ä¸ªstarï¼Œå¯è§è¿™ç§æ–¹å¼å¹¶ä¸ååˆ†æ‹›äººå¾…è§ã€‚

ç½‘ä¸Šä¹Ÿæœ‰äººæå‡ºä½¿ç”¨postgresqlçš„tsdbæ‰©å±•ï¼Œä½†æ˜¯å¦‚æœæ²¡æœ‰ä½¿ç”¨å†å²ï¼Œè€Œæ€§èƒ½åˆæ¯”è¾ƒå…³é”®çš„å‰æä¸‹ï¼Œå¤§å®¶è¿˜æ˜¯ä¼šæ¯”è¾ƒå…³æ³¨æ•°æ®è½åˆ°ä½•ç§dbã€‚

ä¹Ÿæœ‰ä¸€äº›æ–¹æ¡ˆä½¿ç”¨äº†æ··æ­çš„æ–¹å¼æ¥å¯»æ‰¾å‡ºè·¯ï¼Œæ¯”å¦‚ä½¿ç”¨zabbixçš„é‡‡é›†ç«¯ï¼Œä½¿ç”¨grafanaæ¥ä½œå±•ç¤ºç­‰ï¼Œæ–¹æ¡ˆä¹Ÿæ˜¯å¤šç§å¤šæ ·ã€‚è¿™ä¹Ÿå¯è§ç›‘æ§ç›¸å…³äº§å“çš„æ€è·¯éƒ½å·²æ¯”è¾ƒæˆç†Ÿï¼Œå„æœ‰äº®ç‚¹ï¼Œè§£è€¦ä¹Ÿæ¯”è¾ƒå½»åº•ã€‚

### å‚è€ƒ

* Zabbix + InfluxDBï¼š<https://www.zabbix.com/integrations/influxdb>
* Zabbixï¼Œæ—¶é—´åºåˆ—æ•°æ®å’ŒTimescaleDB: <https://zhuanlan.zhihu.com/p/66076630>
* Writing plugins: <https://www.zabbix.com/documentation/4.4/manual/concepts/agent2/writing_plugins>
